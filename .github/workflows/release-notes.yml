# This workflow generates release notes automatically

name: Generate Release Notes

on:
  # å½“åˆ›å»ºæ–°çš„æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name (e.g., v1.0.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´çš„GitåŽ†å²

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Determine tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag_name=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate Release Notes
        id: generate
        run: |
          # ç”ŸæˆRelease Notes
          python scripts/generate_release_notes.py ${{ steps.tag.outputs.tag_name }} --output release_notes.md --print

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
          if [ -f release_notes.md ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "file_path=release_notes.md" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Release Notes as Artifact
        if: steps.generate.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ steps.tag.outputs.tag_name }}
          path: release_notes.md
          retention-days: 30

      - name: Create GitHub Release
        if: steps.generate.outputs.success == 'true' && (github.event_name == 'push' || inputs.create_release)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const tagName = '${{ steps.tag.outputs.tag_name }}';

            // è¯»å–ç”Ÿæˆçš„Release Notes
            const releaseNotes = fs.readFileSync('release_notes.md', 'utf8');

            try {
              // æ£€æŸ¥Releaseæ˜¯å¦å·²å­˜åœ¨
              let release;
              try {
                const existingRelease = await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag: tagName
                });

                // å¦‚æžœå­˜åœ¨ï¼Œæ›´æ–°Release Notes
                release = await github.rest.repos.updateRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: existingRelease.data.id,
                  body: releaseNotes
                });

                console.log(`âœ… å·²æ›´æ–°çŽ°æœ‰Release: ${tagName}`);

              } catch (error) {
                if (error.status === 404) {
                  // Releaseä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„
                  release = await github.rest.repos.createRelease({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    tag_name: tagName,
                    name: `SimTradeLab ${tagName}`,
                    body: releaseNotes,
                    draft: false,
                    prerelease: tagName.includes('alpha') || tagName.includes('beta') || tagName.includes('rc')
                  });

                  console.log(`âœ… å·²åˆ›å»ºæ–°Release: ${tagName}`);
                } else {
                  throw error;
                }
              }

              // è¾“å‡ºRelease URL
              console.log(`ðŸ”— Release URL: ${release.data.html_url}`);

            } catch (error) {
              console.error('âŒ åˆ›å»º/æ›´æ–°Releaseå¤±è´¥:', error);
              throw error;
            }

      - name: Comment on related PRs
        if: steps.generate.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = '${{ steps.tag.outputs.tag_name }}';

            // èŽ·å–ä¸Žæ­¤æ ‡ç­¾ç›¸å…³çš„æäº¤
            const { data: tag } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `tags/${tagName}`
            });

            const commitSha = tag.object.sha;

            // æŸ¥æ‰¾åŒ…å«æ­¤æäº¤çš„PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 50
            });

            for (const pr of prs) {
              if (pr.merge_commit_sha === commitSha) {
                // åœ¨PRä¸­æ·»åŠ è¯„è®º
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `ðŸŽ‰ This PR has been included in release [${tagName}](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${tagName})!`
                });

                console.log(`âœ… å·²åœ¨PR #${pr.number} ä¸­æ·»åŠ å‘å¸ƒé€šçŸ¥`);
                break;
              }
            }

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Release Notes ç”Ÿæˆæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: ${{ steps.tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”ŸæˆçŠ¶æ€**: ${{ steps.generate.outputs.success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.generate.outputs.success }}" = "true" ]; then
            echo "- **æ–‡ä»¶**: ${{ steps.generate.outputs.file_path }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Release**: ${{ (github.event_name == 'push' || inputs.create_release) && 'å·²åˆ›å»º/æ›´æ–°' || 'ä»…ç”Ÿæˆæ–‡ä»¶' }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **ä½¿ç”¨æ–¹æ³•**:" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½ç”Ÿæˆçš„Release Notesæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "2. åœ¨GitHub Releaseä¸­ä½¿ç”¨ç”Ÿæˆçš„å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "3. æ ¹æ®éœ€è¦æ‰‹åŠ¨è°ƒæ•´å†…å®¹" >> $GITHUB_STEP_SUMMARY
