# This workflow will upload SimTradeLab to PyPI when a release is created
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python#publishing-to-package-registries

name: Publish SimTradeLab Package

on:
  release:
    types: [published]
  # å¯é€‰ï¼šå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  release-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libhdf5-dev

          # ä»æºç ç¼–è¯‘å®‰è£…ta-lib
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
          cd ..
          rm -rf ta-lib ta-lib-0.4.0-src.tar.gz

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.11-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Build release distributions
        run: |
          poetry build

      - name: Check build artifacts
        run: |
          ls -la dist/
          echo "Built packages:"
          find dist/ -name "*.whl" -o -name "*.tar.gz"

      - name: Upload distributions
        uses: actions/upload-artifact@v4
        with:
          name: release-dists
          path: dist/

  pypi-publish:
    runs-on: ubuntu-latest
    needs: release-build
    environment: pypi
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Retrieve release distributions
        uses: actions/download-artifact@v4
        with:
          name: release-dists
          path: dist/

      - name: Publish release distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  post-publish:
    runs-on: ubuntu-latest
    needs:
      - pypi-publish
    if: github.event_name == 'release'
    permissions:
      contents: write 

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify PyPI publication
        run: |
          # ç­‰å¾…PyPIç´¢å¼•æ›´æ–°
          sleep 30

          # è·å–ä¸å¸¦vå‰ç¼€çš„ç‰ˆæœ¬å·
          VERSION=${{ github.event.release.tag_name }}
          VERSION=${VERSION#v}

          # å°è¯•å®‰è£…åˆšå‘å¸ƒçš„åŒ…
          pip install simtradelab==$VERSION

          # éªŒè¯å®‰è£…
          python -c 'import simtradelab; from simtradelab.backtest.runner import BacktestRunner; print("âœ… SimTradeLab " + simtradelab.__version__ + " installed successfully")'

      - name: Install script dependencies
        run: |
          pip install gitpython

      - name: Generate Release Notes
        id: release_notes
        run: |
          # ç”ŸæˆRelease Notes
          python scripts/generate_release_notes.py ${{ github.event.release.tag_name }} --output release_notes.md

          # è¯»å–ç”Ÿæˆçš„å†…å®¹å¹¶è®¾ç½®ä¸ºè¾“å‡º
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update Release with Generated Notes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release_notes.md', 'utf8');

            // æ›´æ–°Releaseçš„æè¿°
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: releaseNotes
            });

      - name: Create success comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = '${{ github.event.release.tag_name }}';
            const version = tagName.replace(/^v/, '');
            
            github.rest.issues.createComment({
              issue_number: context.payload.release.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ‰ SimTradeLab ${tagName} has been successfully published to PyPI!

              ğŸ“¦ **Installation:**
              \`\`\`bash
              pip install simtradelab==${version}
              \`\`\`

              ğŸ”— **PyPI Link:** https://pypi.org/project/simtradelab/${version}/

              âœ… **Verification:** Package installation verified successfully.

              ğŸ“‹ **Release Notes:** Automatically generated and updated in the release description.`
            })
